name: ğŸ” Code Quality Check

on:
  push:
    branches: [ main, dev, feature/* ]
  pull_request:
    branches: [ main, dev ]

jobs:
  check:
    name: ğŸš€ Build & Quality Check
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          # è·å–å®Œæ•´å†å²
          fetch-depth: 0

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: ğŸ“š Install Dependencies
        run: pnpm install --frozen-lockfile

      - name:  Code Quality Check
        run: |
          echo "ğŸ” è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥..."
          pnpm lint
          pnpm format:check
          echo "âœ… ä»£ç è´¨é‡æ£€æŸ¥å®Œæˆ"

      - name: ğŸ—ï¸ Build with Timer
        run: |
          echo "ğŸš€ å¼€å§‹æ„å»ºæ£€æŸ¥..."
          pnpm build:timer
          echo "âœ… æ„å»ºæ£€æŸ¥å®Œæˆ"

      - name: ğŸ“Š Build Summary
        if: always()
        run: |
          echo "ğŸ“ˆ æ„å»ºç»“æœæ±‡æ€»"
          echo "=================================="
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼"
            echo "ğŸ‰ ä»£ç è´¨é‡è‰¯å¥½ï¼Œæ„å»ºæˆåŠŸ"
          else
            echo "âŒ æ£€æŸ¥å¤±è´¥ï¼"
            echo "ğŸ’¡ è¯·ä¿®å¤ä¸Šè¿°é—®é¢˜åé‡æ–°æäº¤"
          fi
          echo "=================================="

  # ä»…åœ¨ä¸»åˆ†æ”¯æ„å»ºæ—¶è¿è¡Œé¢å¤–çš„æ£€æŸ¥
  extended-check:
    name: ğŸ”¬ Extended Check
    runs-on: ubuntu-latest
    needs: check
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: ğŸ“š Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ”„ Sync All Documentation
        run: |
          echo "ğŸ”„ åŒæ­¥æ‰€æœ‰æ–‡æ¡£..."
          pnpm sync:all
          echo "âœ… æ–‡æ¡£åŒæ­¥å®Œæˆ"

      - name: ğŸ“Š Generate Statistics
        run: |
          echo "ğŸ“Š ç”Ÿæˆç»Ÿè®¡ä¿¡æ¯..."
          echo "API æ–‡æ¡£ç»Ÿè®¡ï¼š"
          pnpm sync:status
          
          echo ""
          echo "æ–‡ä»¶ç»Ÿè®¡ï¼š"
          find docs/zh -name "*.md" | wc -l | xargs echo "ä¸­æ–‡æ–‡æ¡£æ•°é‡ï¼š"
          find docs/en -name "*.md" | wc -l | xargs echo "è‹±æ–‡æ–‡æ¡£æ•°é‡ï¼š"
          
          echo ""
          echo "ç¿»è¯‘è¿›åº¦ï¼š"
          pnpm translate:status || echo "ç¿»è¯‘çŠ¶æ€æ£€æŸ¥å®Œæˆ"

      - name: ğŸ¯ Performance Check
        run: |
          echo "ğŸ¯ æ€§èƒ½æ£€æŸ¥..."
          echo "æ„å»ºäº§ç‰©å¤§å°ï¼š"
          if [ -d "docs/.vitepress/dist" ]; then
            du -sh docs/.vitepress/dist
          else
            echo "æ„å»ºäº§ç‰©ç›®å½•ä¸å­˜åœ¨"
          fi
