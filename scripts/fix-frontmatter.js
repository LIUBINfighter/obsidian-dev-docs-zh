import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import matter from 'gray-matter';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// æ–‡æ¡£ç›®å½•
const docsDir = path.resolve(__dirname, '../src/content/docs');

/**
 * æ ¹æ®æ–‡ä»¶åç”Ÿæˆæ›´å‹å¥½çš„æ ‡é¢˜
 * å¤„ç†è§„åˆ™ï¼š
 *  - å»æ‰å¸¸è§å‰ç¼€ï¼ˆobsidian-typings.ï¼‰
 *  - ä»¥ç‚¹/è¿å­—ç¬¦/ä¸‹åˆ’çº¿/é©¼å³°åˆ†è¯
 *  - é¦–å­—æ¯å¤§å†™
 */
function generateTitleFromFilename(filePath) {
  const raw = path.basename(filePath, '.md');
  let name = raw;
  // å»å‰ç¼€
  name = name.replace(/^obsidian-typings\./i, '');
  // ç‚¹æ›¿æ¢ä¸ºç©ºæ ¼
  name = name.replace(/\./g, ' ');
  // è¿å­—ç¬¦å’Œä¸‹åˆ’çº¿æ›¿æ¢ä¸ºç©ºæ ¼
  name = name.replace(/[-_]+/g, ' ');
  // é©¼å³°åˆ‡åˆ†ï¼ˆåœ¨å°å†™ä¸å¤§å†™ä¹‹é—´åŠ ç©ºæ ¼ï¼‰
  name = name.replace(/([a-z\d])([A-Z])/g, '$1 $2');
  // å¤šç©ºæ ¼å‹ç¼©
  name = name.replace(/\s+/g, ' ').trim();
  // å•è¯é¦–å­—æ¯å¤§å†™
  name = name.replace(/\b([a-z])(\w*)/g, (m, a, b) => a.toUpperCase() + b);
  return name || raw;
}

/**
 * åˆ¤æ–­è¯¥æ–‡ä»¶æ˜¯å¦ä¸ºè‡ªåŠ¨ç”Ÿæˆï¼ˆåŒ…å«ç‰¹å®šæ ‡è®°ï¼‰
 */
function isAutoGenerated(content) {
  return /automatically generated by API Documenter/i.test(content);
}

/**
 * æ£€æŸ¥å¹¶ä¿®å¤æ–‡æ¡£æ–‡ä»¶çš„ frontmatter
 * @param {string} filePath - æ–‡ä»¶è·¯å¾„
 */
function fixFrontmatter(filePath) {
  const content = fs.readFileSync(filePath, 'utf8');
  const parsed = matter(content);
  const frontmatter = parsed.data || {};
  const body = parsed.content ?? '';
  let modified = false;

  const isIndex = path.basename(filePath) === 'index.md';
  const autoGenerated = isAutoGenerated(content);

  // ä»…å½“ title ç¼ºå¤±æˆ–ä¸ºç©ºå­—ç¬¦ä¸²æ—¶æ‰ç”Ÿæˆ
  const needTitle = !frontmatter.title || (typeof frontmatter.title === 'string' && !frontmatter.title.trim());

  if (isIndex) {
    // ä¿®å¤ index.md çš„ hero.image
    if (frontmatter.hero && frontmatter.hero.image) {
      const image = frontmatter.hero.image;
      if (image.src && image.alt) {
        frontmatter.hero.image = { file: image.src };
        modified = true;
        console.log(`âœ… ä¿®å¤ ${filePath}: hero.image æ ¼å¼å·²æ›´æ–°`);
      } else if (image.file || image.dark || image.light || image.html) {
        // å·²æ˜¯åˆæ³•æ ¼å¼
      } else {
        frontmatter.hero.image = { file: '/logo.svg' };
        modified = true;
        console.log(`âœ… ä¿®å¤ ${filePath}: hero.image è®¾ç½®ä¸ºé»˜è®¤å€¼`);
      }
    }
    if (needTitle) {
      frontmatter.title = generateTitleFromFilename(filePath);
      modified = true;
      console.log(`âœ… ç”Ÿæˆ ${filePath}: æ·»åŠ é¦–é¡µæ ‡é¢˜ "${frontmatter.title}"`);
    }
  } else {
    if (needTitle) {
      const generatedTitle = generateTitleFromFilename(filePath);
      frontmatter.title = generatedTitle;
      modified = true;
      console.log(`âœ… ç”Ÿæˆ ${filePath}: æ·»åŠ æ ‡é¢˜ "${generatedTitle}"` + (autoGenerated ? ' (auto-generated file)' : ''));
    }
    // ä»…å½“ description ç¼ºå¤±æ—¶å¡«å……ï¼ˆä¸è¦†ç›–å·²æœ‰ & ä¸è¦†ç›–è‡ªåŠ¨ç”Ÿæˆæ–‡ä»¶ä»¥é¿å…å™ªéŸ³ï¼Œå¯é…ç½®ï¼‰
    if (!frontmatter.description && !autoGenerated) {
      frontmatter.description = `å…³äº ${frontmatter.title} çš„æ–‡æ¡£`;
      modified = true;
      console.log(`âœ… ç”Ÿæˆ ${filePath}: æ·»åŠ æè¿° "${frontmatter.description}"`);
    }
  }

  if (modified) {
    const newContent = matter.stringify(body.trimStart(), frontmatter).trim() + '\n';
    fs.writeFileSync(filePath, newContent, 'utf8');
  }
}

/**
 * é€’å½’æ‰«æç›®å½•ï¼Œå¤„ç†æ‰€æœ‰ .md æ–‡ä»¶
 * @param {string} dir - ç›®å½•è·¯å¾„
 */
function scanDirectory(dir) {
  console.log(`ğŸ” æ‰«æç›®å½•: ${dir}`);
  const entries = fs.readdirSync(dir, { withFileTypes: true });
  console.log(`ğŸ“„ æ‰¾åˆ° ${entries.length} ä¸ªæ¡ç›®`);

  for (const entry of entries) {
    const fullPath = path.join(dir, entry.name);
    console.log(`  - ${entry.isDirectory() ? 'ğŸ“' : 'ğŸ“„'} ${entry.name}`);

    if (entry.isDirectory()) {
      scanDirectory(fullPath);
    } else if (entry.isFile() && entry.name.endsWith('.md')) {
      console.log(`  ğŸ“ å¤„ç†æ–‡ä»¶: ${fullPath}`);
      fixFrontmatter(fullPath);
    }
  }
}

// ä¸»å‡½æ•°
function main() {
  console.log('ğŸ” å¼€å§‹æ£€æŸ¥å’Œä¿®å¤æ–‡æ¡£å…ƒæ•°æ®...');
  console.log('ğŸ“ æ‰«æç›®å½•:', docsDir);

  if (!fs.existsSync(docsDir)) {
    console.error('âŒ æ–‡æ¡£ç›®å½•ä¸å­˜åœ¨:', docsDir);
    return;
  }

  console.log('ğŸ“‚ ç›®å½•å­˜åœ¨ï¼Œå¼€å§‹æ‰«æ...');
  scanDirectory(docsDir);
  console.log('âœ… å…ƒæ•°æ®æ£€æŸ¥å’Œä¿®å¤å®Œæˆï¼');
}

// å¦‚æœç›´æ¥è¿è¡Œæ­¤è„šæœ¬
if (import.meta.url === `file://${process.argv[1]}` || process.argv[1]?.endsWith('fix-frontmatter.js')) {
  main();
}

export default main;
